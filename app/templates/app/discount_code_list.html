{% extends "base.html" %}

{% block title %}Códigos de Descuento{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Códigos de Descuento</h1>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#discountModal">
            <i class="bi bi-plus-lg"></i> Nuevo Código
        </button>
    </div>

    {% if messages %}
        {% for message in messages %}
            {% if forloop.last %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>Código</th>
                    <th>Evento</th>
                    <th>Descuento</th>
                    <th>Válido Desde</th>
                    <th>Válido Hasta</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for discount in discount_codes %}
                    <tr>
                        <td><strong>{{ discount.code }}</strong></td>
                        <td>{{ discount.event.title }}</td>
                        <td><span class="badge bg-success">{{ discount.discount_percentage }}%</span></td>
                        <td>{{ discount.valid_from|date:"d M Y, H:i" }}</td>
                        <td>{{ discount.valid_until|date:"d M Y, H:i" }}</td>
                        <td>
                            <span class="badge bg-{% if discount.is_valid %}success{% else %}secondary{% endif %}">
                                {% if discount.is_valid %}Activo{% else %}Inactivo{% endif %}
                            </span>
                        </td>
                        <td>
                            <div class="hstack gap-1">
                                <!-- Botón Editar -->
                                <button class="btn btn-sm btn-outline-secondary edit-btn"
                                        aria-label="Editar" title="Editar"
                                        data-bs-toggle="modal" data-bs-target="#discountModal"
                                        data-id="{{ discount.id }}" data-code="{{ discount.code }}"
                                        data-percentage="{{ discount.discount_percentage }}"
                                        data-event="{{ discount.event.id }}"
                                        data-from="{{ discount.valid_from|date:'Y-m-d\TH:i' }}"
                                        data-until="{{ discount.valid_until|date:'Y-m-d\TH:i' }}"
                                        data-active="{{ discount.active|yesno:'true,false' }}">
                                    <i class="bi bi-pencil" aria-hidden="true"></i>
                                </button>

                                <!-- Botón Activar/Desactivar -->
                                <button class="btn btn-sm btn-outline-{% if discount.active %}warning{% else %}success{% endif %} toggle-btn"
                                        title="{% if discount.active %}Desactivar{% else %}Activar{% endif %}"
                                        data-id="{{ discount.id }}">
                                    <i class="bi bi-{% if discount.active %}pause{% else %}play{% endif %}" aria-hidden="true"></i>
                                </button>

                                <!-- Botón Eliminar -->
                                <form action="{% url 'discount_code_delete' discount.id %}" method="POST" class="d-inline">
                                    {% csrf_token %}
                                    <button class="btn btn-sm btn-outline-danger"
                                            title="Eliminar" type="submit" aria-label="Eliminar"
                                            onclick="return confirm('¿Estás seguro de eliminar el código {{ discount.code }}?')">
                                        <i class="bi bi-trash" aria-hidden="true"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                            <i class="bi bi-percent fs-1 d-block mb-2"></i>
                            No hay códigos de descuento creados
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Único para Crear/Editar -->
<div class="modal fade" id="discountModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form method="POST" id="discountForm">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Crear Código de Descuento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Código de Descuento</label>
                                <input type="text" class="form-control" name="code" id="code" required 
                                       minlength="3" maxlength="50" placeholder="Ej: DESCUENTO2024">
                                <div class="invalid-feedback"></div>
                                <div class="form-text">Mínimo 3 caracteres</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Porcentaje de Descuento (%)</label>
                                <input type="number" class="form-control" name="discount_percentage" 
                                       id="percentage" required min="0" max="100" step="0.01">
                                <div class="invalid-feedback"></div>
                                <div class="form-text">Entre 0 y 100</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Evento</label>
                        <select class="form-select" name="event" id="event" required>
                            <option value="">Seleccionar evento...</option>
                            {% for event in user_events %}
                                <option value="{{ event.id }}">{{ event.title }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Válido Desde</label>
                                <input type="datetime-local" class="form-control" name="valid_from" 
                                       id="validFrom" required>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Válido Hasta</label>
                                <input type="datetime-local" class="form-control" name="valid_until" 
                                       id="validUntil" required>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="active" id="active" checked>
                        <label class="form-check-label">Activo</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Crear Código</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('discountModal');
    const form = document.getElementById('discountForm');
    const title = document.getElementById('modalTitle');
    const submitBtn = document.getElementById('submitBtn');
    let isEditing = false;

    // Función para mostrar error en campo específico
    function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const feedback = field.parentNode.querySelector('.invalid-feedback');
        field.classList.add('is-invalid');
        if (feedback) feedback.textContent = message;
    }

    // Función para limpiar errores
    function clearFieldErrors() {
        document.querySelectorAll('.is-invalid').forEach(field => {
            field.classList.remove('is-invalid');
        });
        document.querySelectorAll('.invalid-feedback').forEach(feedback => {
            feedback.textContent = '';
        });
    }

    // Validación mejorada del formulario
    function validate() {
        clearFieldErrors();
        let hasErrors = false;

        const code = document.getElementById('code').value.trim();
        const percentage = parseFloat(document.getElementById('percentage').value);
        const event = document.getElementById('event').value;
        const validFrom = new Date(document.getElementById('validFrom').value);
        const validUntil = new Date(document.getElementById('validUntil').value);
        const now = new Date();

        // Validar código
        if (code.length < 3) {
            showFieldError('code', 'El código debe tener al menos 3 caracteres');
            hasErrors = true;
        }

        // Validar porcentaje
        if (isNaN(percentage) || percentage < 0 || percentage > 100) {
            showFieldError('percentage', 'El porcentaje debe estar entre 0 y 100');
            hasErrors = true;
        }

        // Validar evento
        if (!event) {
            showFieldError('event', 'Debe seleccionar un evento');
            hasErrors = true;
        }

        // Validar fechas
        if (validFrom >= validUntil) {
            showFieldError('validUntil', 'La fecha de fin debe ser posterior a la fecha de inicio');
            hasErrors = true;
        }

        if (!isEditing && validUntil <= now) {
            showFieldError('validUntil', 'La fecha de fin no puede ser en el pasado');
            hasErrors = true;
        }

        return !hasErrors;
    }

    // Validación en tiempo real para fechas
    function addDateValidation() {
        const validFrom = document.getElementById('validFrom');
        const validUntil = document.getElementById('validUntil');

        validUntil.addEventListener('change', function() {
            const fromDate = new Date(validFrom.value);
            const untilDate = new Date(this.value);
            const now = new Date();
            const feedback = this.parentNode.querySelector('.invalid-feedback');

            this.classList.remove('is-invalid');
            feedback.textContent = '';

            if (validFrom.value && fromDate >= untilDate) {
                this.classList.add('is-invalid');
                feedback.textContent = 'La fecha de fin debe ser posterior a la fecha de inicio';
            } else if (!isEditing && untilDate <= now) {
                this.classList.add('is-invalid');
                feedback.textContent = 'La fecha de fin no puede ser en el pasado';
            }
        });

        validFrom.addEventListener('change', function() {
            // Revalidar fecha de fin si ya tiene valor
            if (validUntil.value) {
                validUntil.dispatchEvent(new Event('change'));
            }
        });
    }

    // Envío del formulario
    form.addEventListener('submit', function(e) {
        if (!validate()) {
            e.preventDefault();
            return;
        }
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
    });

    // Limpiar modal al abrir
    modal.addEventListener('show.bs.modal', function(e) {
        const trigger = e.relatedTarget;
        clearFieldErrors();
        
        if (trigger && trigger.classList.contains('edit-btn')) {
            // Modo edición
            isEditing = true;
            title.textContent = 'Editar Código de Descuento';
            submitBtn.textContent = 'Guardar Cambios';
            form.action = `/discount-codes/${trigger.dataset.id}/update/`;
            
            // Llenar campos
            document.getElementById('code').value = trigger.dataset.code;
            document.getElementById('percentage').value = parseFloat(trigger.dataset.percentage).toFixed(2);
            document.getElementById('event').value = trigger.dataset.event;
            document.getElementById('validFrom').value = trigger.dataset.from;
            document.getElementById('validUntil').value = trigger.dataset.until;
            document.getElementById('active').checked = trigger.dataset.active === 'true';
        } else {
            // Modo creación
            isEditing = false;
            title.textContent = 'Crear Código de Descuento';
            submitBtn.textContent = 'Crear Código';
            form.action = '{% url "discount_code_create" %}';
            form.reset();
            document.getElementById('active').checked = true;
        }
        submitBtn.disabled = false;
    });

    // Inicializar validaciones
    addDateValidation();

    // Toggle activo/inactivo
    document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            fetch(`/discount-codes/${id}/toggle-active/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => data.success && location.reload())
            .catch(() => alert('Error al cambiar el estado'));
        });
    });
});
</script>
{% endblock %}